<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search Academy</title>
  <link rel="shortcut icon" href="../logo-icon.ico" type="image/x-icon">
  <link rel="stylesheet" href="subcategorias-cards.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <a href="../tela_inicial/tela_inicial.html" class="lobster-regular">
    <div class="lobster-regular">
      <span class="Search">Search</span> <span class="Academy">Academy</span>
    </div>
  </a>
  <div class="search-bar">
    <span class="stash--search-solid"></span>
    <input id="searchInput" type="text" placeholder="Qual atividade você procura?" />
  </div>
  <div class="icons">
    <a href="../perfil/perfil.html">
      <button class="icon-button"><span class="mingcute--user-4-fill"></span></button>
    </a>
    <a href="../notificacoes/notificacoes.html">
      <button class="icon-button"><span class="mingcute--notification-line"></span></button>
    </a>
  </div>
</header>

<!-- Botão de criar nova categoria -->
<div class="actions">
  <button onclick="abrirFormularioCategoria()">+ Nova Categoria</button>
</div>

<!-- Categorias -->
<div class="category-wrapper">
  <button class="scroll-btn left" onclick="scrollCategories(-1)">&#8249;</button>
  <div class="category-container" id="categoryContainer"></div>
  <button class="scroll-btn right" onclick="scrollCategories(1)">&#8250;</button>
</div>

<!-- Cards -->
<section class="cards" id="cardsContainer"></section>

<!-- Overlay e Formulário de nova categoria -->
<div id="overlay" onclick="fecharFormularioCategoria()"></div>
<div id="novaCategoriaForm">
  <h2>Nova Categoria</h2>
  <input type="text" id="nomeCategoria" placeholder="Nome da categoria" required />
  <textarea id="descricaoCategoria" placeholder="Descrição"></textarea>
  <button onclick="criarCategoria()">Salvar</button>
  <button onclick="fecharFormularioCategoria()" class="cancel">Cancelar</button>
</div>

<script>
  const API_BASE = "http://localhost:3000";

  // ⚡ Busca categorias e atividades da API (suas rotas Node + Prisma)
  async function fetchData() {
    const [categoriasRes, atividadesRes] = await Promise.all([
      fetch("/api/categorias"),   // rota que retorna extracurriculares
      fetch("/api/atividades")   // rota que retorna atividades
    ]);
    const categorias = await categoriasRes.json();
    const atividades = await atividadesRes.json();
    return { categorias, atividades };
  }

  // Renderizar categorias
  function renderCategorias(categorias, atividades) {
    const container = document.getElementById("categoryContainer");
    container.innerHTML = "";

    categorias.forEach(cat => {
      const div = document.createElement("div");
      div.className = "category";
      div.innerHTML = `<span class="${cat.iconClass}"></span><span>${cat.nome}</span>`;
      div.onclick = () => renderCards(atividades.filter(a => a.extracurricularId === cat.id));
      container.appendChild(div);
    });
  }

  // Renderizar cards
  function renderCards(atividades) {
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";

    if (atividades.length === 0) {
      container.innerHTML = `<p style="grid-column:1/-1;text-align:center">Nenhuma atividade encontrada.</p>`;
      return;
    }

    atividades.forEach(atividade => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${atividade.imagem || '/images/default.jpg'}" alt="${atividade.titulo}" />
        <div class="card-content">
          <div class="card-title">${atividade.titulo}</div>
          <div class="card-description">${atividade.descricao}</div>
        </div>
        <button onclick="window.open('${atividade.url || '#'}','_blank')">SAIBA MAIS!</button>
      `;
      container.appendChild(card);
    });
  }

  // Filtro de busca
  function setupSearch(atividades) {
    const input = document.getElementById("searchInput");
    input.addEventListener("input", () => {
      const termo = input.value.toLowerCase();
      const filtradas = atividades.filter(a => 
        a.titulo.toLowerCase().includes(termo) || 
        a.descricao.toLowerCase().includes(termo)
      );
      renderCards(filtradas);
    });
  }

  // Scroll categorias
  function scrollCategories(direction) {
    const container = document.getElementById("categoryContainer");
    container.scrollBy({ left: direction * 200, behavior: "smooth" });
  }

  // ---------------------- Cadastro de nova categoria ----------------------
  function abrirFormularioCategoria() {
    document.getElementById("overlay").style.display = "block";
    document.getElementById("novaCategoriaForm").style.display = "block";
  }

  function fecharFormularioCategoria() {
    document.getElementById("overlay").style.display = "none";
    document.getElementById("novaCategoriaForm").style.display = "none";
  }

  async function criarCategoria() {
    const nome = document.getElementById("nomeCategoria").value.trim();
    const descricao = document.getElementById("descricaoCategoria").value.trim();

    if (!nome) {
      alert("O nome da categoria é obrigatório!");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/categorias`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, descricao })
      });

      if (!res.ok) throw new Error("Erro ao salvar categoria");

      const novaCategoria = await res.json();

      fecharFormularioCategoria();

      // Adiciona a nova categoria no topo
      const container = document.getElementById("categoryContainer");
      const div = document.createElement("div");
      div.className = "category";
      div.innerHTML = `<span>${novaCategoria.nome}</span>`;
      div.onclick = () => renderCards([]);
      container.prepend(div);

      document.getElementById("nomeCategoria").value = "";
      document.getElementById("descricaoCategoria").value = "";

    } catch (error) {
      console.error("Erro ao criar categoria:", error);
    }
  }

  // Inicializar página
  (async () => {
    const { categorias, atividades } = await fetchData();
    renderCategorias(categorias, atividades);
    renderCards(atividades); // mostra tudo no início
    setupSearch(atividades);
  })();
</script>

</body>
</html>
